# I18n (Localization)

This module provides a small, typed localization surface that fits AIVI's existing primitives:

- `Effect E A` for explicit failure/cancellation.
- Sigils for compile-time validation of structured literals.

This is intentionally a minimal v0.1 foundation: key validation, message template validation, bundle loading, lookup, and rendering.


## Module

```aivi
use aivi.i18n
```


## Types

```aivi
type Locale  = { language: Text, region: Option Text, variants: List Text, tag: Text }
type Key     = { tag: Text, body: Text, flags: Text }
type Message = { tag: Text, body: Text, flags: Text }
type Bundle  = { locale: Locale, entries: Map Text Message }
```

Notes:

- `Key` and `Message` are implemented as record-shaped sigil values. They are open records in practice (tooling may attach extra fields).
- `Bundle.entries` is keyed by the key text (`Text`). `Key` is a typed wrapper for that text.


## Sigils

### `~k"..."` (keys)

```aivi
welcomeKey : Key
welcomeKey = ~k"app.welcome"
```

`~k` is validated at parse time:

- non-empty
- dot-separated segments (`a.b.c`)
- no empty segments (`"a..b"`, `".a"`, `"a."` are rejected)
- each segment must start with `[A-Za-z_]` and contain only `[A-Za-z0-9_-]`

### `~m"..."` (messages)

```aivi
welcomeMsg : Message
welcomeMsg = ~m"Hello, {name:Text}!"
```

`~m` is validated at parse time using a small template language:

- literal text
- escaped braces: <code v-pre>{{</code> renders `{`, <code v-pre>}}</code> renders `}`
- placeholders: `{name}` or `{name:Type}`

Supported placeholder types in v0.1:

- `Text`, `Int`, `Float`, `Bool`, `Decimal`, `DateTime`

When rendering, a placeholder with a `:Type` annotation is checked at runtime.

Important: AIVI `Text` literals also support interpolation with `{ Expr }` (see Syntax). If you want literal braces inside a `Text` literal, escape them as `\\{` and `\\}`:

```aivi
// AIVI Text literal that contains a message template
raw = "Hello, \\{name:Text\\}!"
msg = message raw
```


## API

```aivi
parseLocale : Text -> Result Text Locale

key     : Text -> Result Text Key
message : Text -> Result Text Message

render : Message -> {} -> Result Text Text

bundleFromProperties : Locale -> Text -> Result Text Bundle
bundleFromPropertiesFile : Locale -> Text -> Effect Text (Result Text Bundle)

tResult       : Bundle -> Key -> {} -> Result Text Text
tOpt          : Bundle -> Key -> {} -> Option Text
t             : Bundle -> Key -> {} -> Text
tWithFallback : List Bundle -> Key -> {} -> Text
```

### Properties catalogs

`bundleFromProperties` consumes a simple `.properties`-style format:

```text
app.welcome = Hello, {name:Text}!
app.cartItems = You have {count:Int} items.
```

Lines starting with `#` and blank lines are ignored.


## Tooling: `aivi i18n gen`

The compiler ships a small generator for `.properties` catalogs:

```text
aivi i18n gen <catalog.properties> --locale <tag> --module <name> --out <file>
```

It emits an AIVI module containing:

- `KeyId` (a generated sum type of keys)
- `keyText : KeyId -> Text`
- `bundle` (a `Map` of compiled `~m"..."` messages)
- `t : KeyId -> {} -> Text`

This lets projects use generated constructors (typo-proof) while keeping runtime lookup on `Text` keys.

