# I18n (Localization)

<!-- quick-info: {"kind":"module","name":"aivi.i18n"} -->
This module provides a small, typed localization surface that fits AIVI's existing primitives:

- `Effect E A` for explicit failure/cancellation.
- Sigils for compile-time validation of structured literals.

This is intentionally a minimal v0.1 foundation: key validation, message template validation, bundle loading, lookup, and rendering.


<!-- /quick-info -->
## Module

<<< ../../snippets/from_md/05_stdlib/00_core/29_i18n/block_01.aivi{aivi}


## Types

<<< ../../snippets/from_md/05_stdlib/00_core/29_i18n/block_02.aivi{aivi}

Notes:

- `Key` and `Message` are implemented as record-shaped sigil values. They are open records in practice (tooling may attach extra fields).
- `Bundle.entries` is keyed by the key text (`Text`). `Key` is a typed wrapper for that text.


## Sigils

### `~k"..."` (keys)

<<< ../../snippets/from_md/05_stdlib/00_core/29_i18n/block_03.aivi{aivi}

`~k` is validated at parse time:

- non-empty
- dot-separated segments (`a.b.c`)
- no empty segments (`"a..b"`, `".a"`, `"a."` are rejected)
- each segment must start with `[A-Za-z_]` and contain only `[A-Za-z0-9_-]`

### `~m"..."` (messages)

<<< ../../snippets/from_md/05_stdlib/00_core/29_i18n/block_04.aivi{aivi}

`~m` is validated at parse time using a small template language:

- literal text
- escaped braces: <code v-pre>{{</code> renders `{`, <code v-pre>}}</code> renders `}`
- placeholders: `{name}` or `{name:Type}`

Supported placeholder types in v0.1:

- `Text`, `Int`, `Float`, `Bool`, `Decimal`, `DateTime`

When rendering, a placeholder with a `:Type` annotation is checked at runtime.

Important: AIVI `Text` literals also support interpolation with `{ Expr }` (see Syntax). If you want literal braces inside a `Text` literal, escape them as `\\{` and `\\}`:

<<< ../../snippets/from_md/05_stdlib/00_core/29_i18n/block_05.aivi{aivi}


## API

<<< ../../snippets/from_md/05_stdlib/00_core/29_i18n/block_06.aivi{aivi}

### Properties catalogs

`bundleFromProperties` consumes a simple `.properties`-style format:

```text
app.welcome = Hello, {name:Text}!
app.cartItems = You have {count:Int} items.
```

Lines starting with `#` and blank lines are ignored.


## Tooling: `aivi i18n gen`

The compiler ships a small generator for `.properties` catalogs:

```text
aivi i18n gen <catalog.properties> --locale <tag> --module <name> --out <file>
```

It emits an AIVI module containing:

- `KeyId` (a generated sum type of keys)
- `keyText : KeyId -> Text`
- `bundle` (a `Map` of compiled `~m"..."` messages)
- `t : KeyId -> {} -> Text`

This lets projects use generated constructors (typo-proof) while keeping runtime lookup on `Text` keys.

## Common Patterns

### 1) Determine the user's locale (system best-effort)

Use `aivi.system.localeTag` to fetch a best-effort locale tag from the host system, then parse it with `parseLocale` and fall back to a known default.

<<< ../../snippets/from_md/05_stdlib/00_core/29_i18n/block_07.aivi{aivi}

Notes:

- `localeTag` is host-dependent; on Unix-like systems it uses `LC_ALL`, `LC_MESSAGES`, `LANG` (in that order) and strips suffixes like `.UTF-8` and `@modifier`.
- `parseLocale` accepts `-` or `_` separated tags (e.g. `en-US`, `en_US`).

### 2) Load a bundle from disk (with a `Resource`)

If you just need a file-based catalog, use `bundleFromPropertiesFile`:

<<< ../../snippets/from_md/05_stdlib/00_core/29_i18n/block_08.aivi{aivi}

If you want to be explicit about resource lifetimes (or reuse an already-open handle), combine `aivi.file.open` with `bundleFromProperties`:

<<< ../../snippets/from_md/05_stdlib/00_core/29_i18n/block_09.aivi{aivi}

### 3) Translate a message with placeholders (including dates)

<<< ../../snippets/from_md/05_stdlib/00_core/29_i18n/block_10.aivi{aivi}

Formatting note (v0.1):

- `DateTime` placeholders are currently rendered using the runtime's default `DateTime -> Text` formatting (locale-neutral; typically ISO-8601-ish).
- If you need locale-specific date formatting today, pre-format the date into a `Text` value at the boundary (host runtime / external source), and use `{when:Text}` in your message template.

### 4) Bundles and fallbacks

Use `tWithFallback` when you have multiple bundles (e.g. app bundle + shared bundle, or user locale + default locale):

<<< ../../snippets/from_md/05_stdlib/00_core/29_i18n/block_11.aivi{aivi}

### 5) Locale fallback and catalogs

When you have multiple locale bundles available at once, use a `Catalog` (`Map Text Bundle`) keyed by locale tag:

<<< ../../snippets/from_md/05_stdlib/00_core/29_i18n/block_12.aivi{aivi}
